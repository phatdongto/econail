{"ast":null,"code":"function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport { all, takeEvery, put, call, fork, select } from 'redux-saga/effects';\nimport actions from './actions';\nimport { rsf, db } from '@iso/lib/firebase/firebase';\nimport { getDocuments, getDocumentsByQuery, addDocument, setDocument, getNewDocRef } from '@iso/lib/firebase/firebase.util';\n\nconst getSelectedChatRoom = state => state.Chat.selectedChatRoom;\n\nconst fsProps = {};\n\nconst reverseString = str => str.split('').reverse().join('');\n\nconst sortChatrooms = (optionA, optionB) => optionB.lastMessageTime - optionA.lastMessageTime;\n\nconst sortMessages = (optionA, optionB) => optionA.messageTime - optionB.messageTime;\n\nconst getCurrentUser = () => {\n  return {\n    userId: 'wt4TiasxgPrQ3dNwVZ55',\n    user: {\n      id: 'wt4TiasxgPrQ3dNwVZ55',\n      dob: '06-Apr-1993',\n      gender: 'Male',\n      language: 'Burmese',\n      mobileNo: '5726784596',\n      name: 'Zondra Kulic',\n      profileImageUrl: 'https://s3.amazonaws.com/redqteam.com/mateadmin/support-male-zonra.png'\n    }\n  };\n};\n\nlet chatroomsUserCollections;\nlet chatroomCollectionRef = db.collection('chatRooms');\nlet messagesCollectionRef = db.collection('messages');\n\nconst sendMessageBatch = async ({\n  payload,\n  selectedChatRoom\n}) => {\n  const batch = db.batch(); // const { chatRoom, text } = payload;\n\n  console.log(selectedChatRoom, payload, 'send');\n  const revId = reverseString(selectedChatRoom.id);\n  const messageTime = new Date().getTime();\n  const chatRoomModified = {\n    lastMessage: payload,\n    lastMessageTime: messageTime\n  };\n  batch.update(chatroomCollectionRef.doc(selectedChatRoom.id), chatRoomModified);\n  batch.update(chatroomCollectionRef.doc(revId), chatRoomModified);\n  batch.set(messagesCollectionRef.doc(), {\n    sender: selectedChatRoom.userId,\n    text: payload,\n    messageTime,\n    chatRoomId: selectedChatRoom.id\n  });\n  batch.commit(); // yield fork(updateChatrooms);\n};\n\nfunction* initChat(action) {\n  // console.log(payload, 'chatinit');\n  const payload = getCurrentUser();\n  const users = yield call(getDocuments, 'users');\n  const chatRooms = yield call(getDocumentsByQuery, 'chatRooms', ['userId', '==', payload.userId]);\n  chatRooms.sort(sortChatrooms);\n  const messages = yield call(getDocumentsByQuery, 'messages', ['chatRoomId', '==', chatRooms[0].id]);\n  console.log(chatRooms, 'chatRooms');\n  messages.sort(sortMessages); // fsProps.selectedChatRoom = chatRooms.length > 0 && chatRooms[0];\n\n  chatroomsUserCollections = db.collection('chatRooms').where('userId', '==', payload.userId);\n  yield fork(updateChatrooms);\n  yield put({\n    type: actions.CHAT_INIT_SAGA,\n    user: payload.user,\n    userId: payload.userId,\n    users,\n    chatRooms,\n    messages\n  });\n}\n\nfunction* sendMessage({\n  payload\n}) {\n  // fsProps.selectedChatRoom = payload.chatRoom;\n  const selectedChatRoom = yield select(getSelectedChatRoom);\n  yield call(sendMessageBatch, {\n    payload,\n    selectedChatRoom\n  });\n  yield put({\n    type: actions.NEW_MESSAGE_SUCCESFULL\n  }); // yield fork(updateChatrooms);\n}\n\nfunction* addNewUser({\n  user,\n  addNewUsersProp\n}) {\n  const newUserId = yield call(addDocument, 'users', addNewUsersProp);\n\n  const newUser = _objectSpread({\n    id: newUserId\n  }, addNewUsersProp);\n\n  const newChatroom = {\n    reverse: false,\n    userId: user.id,\n    otherUserId: newUserId,\n    otherUserInfo: newUser,\n    lastMessage: '',\n    lastMessageTime: 0\n  };\n  const newChatRoomId = yield call(addDocument, 'chatRooms', newChatroom);\n  const chatRoomKeyRev = reverseString(newChatRoomId);\n  const newChatroomRev = {\n    id: chatRoomKeyRev,\n    reverse: true,\n    userId: newUserId,\n    otherUserId: user.id,\n    otherUserInfo: user,\n    lastMessage: '',\n    lastMessageTime: 0\n  };\n  yield call(addDocument, 'chatRooms', newChatroomRev);\n  yield put({\n    type: actions.ADD_NEW_USER_SAGA,\n    user: newUser,\n    chatRoom: _objectSpread({\n      id: newChatRoomId\n    }, newChatroom)\n  });\n}\n\nfunction* updateChatrooms() {\n  const successActionCreator = data => {\n    const {\n      type,\n      newIndex\n    } = data.docChanges()[0];\n    const dataMoodified = type === 'modified';\n\n    if (!dataMoodified) {\n      return {\n        type: 'NO_CHANGE'\n      };\n    }\n\n    const chatRoom = data.docs[newIndex].data();\n    return {\n      type: actions.CHAT_UPDATE_CHATROOM_SAGA,\n      payload: {\n        chatRoom\n      }\n    };\n  };\n\n  yield call(rsf.firestore.syncCollection, chatroomsUserCollections, {\n    successActionCreator\n  });\n}\n\nfunction* updateChatroomSaga({\n  payload\n}) {\n  const {\n    chatRoom\n  } = payload;\n  let {\n    selected\n  } = payload;\n  const selectedChatRoom = yield select(getSelectedChatRoom);\n  let messages;\n\n  if (selected || chatRoom.id === selectedChatRoom.id) {\n    messages = yield call(getDocumentsByQuery, 'messages', ['chatRoomId', '==', chatRoom.id]);\n    selected = true;\n  }\n\n  yield put({\n    type: actions.CHAT_UPDATE_CHATROOM,\n    chatRoom,\n    messages,\n    selected\n  });\n}\n\nexport default function* rootSaga() {\n  yield all([takeEvery(actions.CHAT_INIT, initChat), takeEvery(actions.CHAT_UPDATE_CHATROOM_SAGA, updateChatroomSaga), takeEvery(actions.CHAT_SEND_MESSAGE, sendMessage), takeEvery(actions.ADD_NEW_USER, addNewUser)]);\n}","map":{"version":3,"sources":["D:/Team6-FE/isomorphic/node_modules/@iso/redux/chat/sagas.js"],"names":["all","takeEvery","put","call","fork","select","actions","rsf","db","getDocuments","getDocumentsByQuery","addDocument","setDocument","getNewDocRef","getSelectedChatRoom","state","Chat","selectedChatRoom","fsProps","reverseString","str","split","reverse","join","sortChatrooms","optionA","optionB","lastMessageTime","sortMessages","messageTime","getCurrentUser","userId","user","id","dob","gender","language","mobileNo","name","profileImageUrl","chatroomsUserCollections","chatroomCollectionRef","collection","messagesCollectionRef","sendMessageBatch","payload","batch","console","log","revId","Date","getTime","chatRoomModified","lastMessage","update","doc","set","sender","text","chatRoomId","commit","initChat","action","users","chatRooms","sort","messages","where","updateChatrooms","type","CHAT_INIT_SAGA","sendMessage","NEW_MESSAGE_SUCCESFULL","addNewUser","addNewUsersProp","newUserId","newUser","newChatroom","otherUserId","otherUserInfo","newChatRoomId","chatRoomKeyRev","newChatroomRev","ADD_NEW_USER_SAGA","chatRoom","successActionCreator","data","newIndex","docChanges","dataMoodified","docs","CHAT_UPDATE_CHATROOM_SAGA","firestore","syncCollection","updateChatroomSaga","selected","CHAT_UPDATE_CHATROOM","rootSaga","CHAT_INIT","CHAT_SEND_MESSAGE","ADD_NEW_USER"],"mappings":";;;;;;AAAA,SAASA,GAAT,EAAcC,SAAd,EAAyBC,GAAzB,EAA8BC,IAA9B,EAAoCC,IAApC,EAA0CC,MAA1C,QAAwD,oBAAxD;AACA,OAAOC,OAAP,MAAoB,WAApB;AACA,SAASC,GAAT,EAAcC,EAAd,QAAwB,4BAAxB;AACA,SACEC,YADF,EAEEC,mBAFF,EAGEC,WAHF,EAIEC,WAJF,EAKEC,YALF,QAMO,iCANP;;AAOA,MAAMC,mBAAmB,GAAGC,KAAK,IAAIA,KAAK,CAACC,IAAN,CAAWC,gBAAhD;;AACA,MAAMC,OAAO,GAAG,EAAhB;;AACA,MAAMC,aAAa,GAAGC,GAAG,IACvBA,GAAG,CACAC,KADH,CACS,EADT,EAEGC,OAFH,GAGGC,IAHH,CAGQ,EAHR,CADF;;AAMA,MAAMC,aAAa,GAAG,CAACC,OAAD,EAAUC,OAAV,KACpBA,OAAO,CAACC,eAAR,GAA0BF,OAAO,CAACE,eADpC;;AAEA,MAAMC,YAAY,GAAG,CAACH,OAAD,EAAUC,OAAV,KACnBD,OAAO,CAACI,WAAR,GAAsBH,OAAO,CAACG,WADhC;;AAEA,MAAMC,cAAc,GAAG,MAAM;AAC3B,SAAO;AACLC,IAAAA,MAAM,EAAE,sBADH;AAELC,IAAAA,IAAI,EAAE;AACJC,MAAAA,EAAE,EAAE,sBADA;AAEJC,MAAAA,GAAG,EAAE,aAFD;AAGJC,MAAAA,MAAM,EAAE,MAHJ;AAIJC,MAAAA,QAAQ,EAAE,SAJN;AAKJC,MAAAA,QAAQ,EAAE,YALN;AAMJC,MAAAA,IAAI,EAAE,cANF;AAOJC,MAAAA,eAAe,EACb;AARE;AAFD,GAAP;AAaD,CAdD;;AAgBA,IAAIC,wBAAJ;AACA,IAAIC,qBAAqB,GAAGjC,EAAE,CAACkC,UAAH,CAAc,WAAd,CAA5B;AACA,IAAIC,qBAAqB,GAAGnC,EAAE,CAACkC,UAAH,CAAc,UAAd,CAA5B;;AACA,MAAME,gBAAgB,GAAG,OAAO;AAAEC,EAAAA,OAAF;AAAW5B,EAAAA;AAAX,CAAP,KAAyC;AAChE,QAAM6B,KAAK,GAAGtC,EAAE,CAACsC,KAAH,EAAd,CADgE,CAEhE;;AAEAC,EAAAA,OAAO,CAACC,GAAR,CAAY/B,gBAAZ,EAA8B4B,OAA9B,EAAuC,MAAvC;AACA,QAAMI,KAAK,GAAG9B,aAAa,CAACF,gBAAgB,CAACgB,EAAlB,CAA3B;AACA,QAAMJ,WAAW,GAAG,IAAIqB,IAAJ,GAAWC,OAAX,EAApB;AACA,QAAMC,gBAAgB,GAAG;AACvBC,IAAAA,WAAW,EAAER,OADU;AAEvBlB,IAAAA,eAAe,EAAEE;AAFM,GAAzB;AAIAiB,EAAAA,KAAK,CAACQ,MAAN,CACEb,qBAAqB,CAACc,GAAtB,CAA0BtC,gBAAgB,CAACgB,EAA3C,CADF,EAEEmB,gBAFF;AAIAN,EAAAA,KAAK,CAACQ,MAAN,CAAab,qBAAqB,CAACc,GAAtB,CAA0BN,KAA1B,CAAb,EAA+CG,gBAA/C;AACAN,EAAAA,KAAK,CAACU,GAAN,CAAUb,qBAAqB,CAACY,GAAtB,EAAV,EAAuC;AACrCE,IAAAA,MAAM,EAAExC,gBAAgB,CAACc,MADY;AAErC2B,IAAAA,IAAI,EAAEb,OAF+B;AAGrChB,IAAAA,WAHqC;AAIrC8B,IAAAA,UAAU,EAAE1C,gBAAgB,CAACgB;AAJQ,GAAvC;AAMAa,EAAAA,KAAK,CAACc,MAAN,GAtBgE,CAuBhE;AACD,CAxBD;;AA0BA,UAAUC,QAAV,CAAmBC,MAAnB,EAA2B;AACzB;AAEA,QAAMjB,OAAO,GAAGf,cAAc,EAA9B;AACA,QAAMiC,KAAK,GAAG,MAAM5D,IAAI,CAACM,YAAD,EAAe,OAAf,CAAxB;AAEA,QAAMuD,SAAS,GAAG,MAAM7D,IAAI,CAACO,mBAAD,EAAsB,WAAtB,EAAmC,CAC7D,QAD6D,EAE7D,IAF6D,EAG7DmC,OAAO,CAACd,MAHqD,CAAnC,CAA5B;AAKAiC,EAAAA,SAAS,CAACC,IAAV,CAAezC,aAAf;AACA,QAAM0C,QAAQ,GAAG,MAAM/D,IAAI,CAACO,mBAAD,EAAsB,UAAtB,EAAkC,CAC3D,YAD2D,EAE3D,IAF2D,EAG3DsD,SAAS,CAAC,CAAD,CAAT,CAAa/B,EAH8C,CAAlC,CAA3B;AAKAc,EAAAA,OAAO,CAACC,GAAR,CAAYgB,SAAZ,EAAuB,WAAvB;AACAE,EAAAA,QAAQ,CAACD,IAAT,CAAcrC,YAAd,EAlByB,CAmBzB;;AACAY,EAAAA,wBAAwB,GAAGhC,EAAE,CAC1BkC,UADwB,CACb,WADa,EAExByB,KAFwB,CAElB,QAFkB,EAER,IAFQ,EAEFtB,OAAO,CAACd,MAFN,CAA3B;AAGA,QAAM3B,IAAI,CAACgE,eAAD,CAAV;AACA,QAAMlE,GAAG,CAAC;AACRmE,IAAAA,IAAI,EAAE/D,OAAO,CAACgE,cADN;AAERtC,IAAAA,IAAI,EAAEa,OAAO,CAACb,IAFN;AAGRD,IAAAA,MAAM,EAAEc,OAAO,CAACd,MAHR;AAIRgC,IAAAA,KAJQ;AAKRC,IAAAA,SALQ;AAMRE,IAAAA;AANQ,GAAD,CAAT;AAQD;;AAED,UAAUK,WAAV,CAAsB;AAAE1B,EAAAA;AAAF,CAAtB,EAAmC;AACjC;AACA,QAAM5B,gBAAgB,GAAG,MAAMZ,MAAM,CAACS,mBAAD,CAArC;AAEA,QAAMX,IAAI,CAACyC,gBAAD,EAAmB;AAAEC,IAAAA,OAAF;AAAW5B,IAAAA;AAAX,GAAnB,CAAV;AACA,QAAMf,GAAG,CAAC;AACRmE,IAAAA,IAAI,EAAE/D,OAAO,CAACkE;AADN,GAAD,CAAT,CALiC,CAQjC;AACD;;AACD,UAAUC,UAAV,CAAqB;AAAEzC,EAAAA,IAAF;AAAQ0C,EAAAA;AAAR,CAArB,EAAgD;AAC9C,QAAMC,SAAS,GAAG,MAAMxE,IAAI,CAACQ,WAAD,EAAc,OAAd,EAAuB+D,eAAvB,CAA5B;;AACA,QAAME,OAAO;AAAK3C,IAAAA,EAAE,EAAE0C;AAAT,KAAuBD,eAAvB,CAAb;;AACA,QAAMG,WAAW,GAAG;AAClBvD,IAAAA,OAAO,EAAE,KADS;AAElBS,IAAAA,MAAM,EAAEC,IAAI,CAACC,EAFK;AAGlB6C,IAAAA,WAAW,EAAEH,SAHK;AAIlBI,IAAAA,aAAa,EAAEH,OAJG;AAKlBvB,IAAAA,WAAW,EAAE,EALK;AAMlB1B,IAAAA,eAAe,EAAE;AANC,GAApB;AAQA,QAAMqD,aAAa,GAAG,MAAM7E,IAAI,CAACQ,WAAD,EAAc,WAAd,EAA2BkE,WAA3B,CAAhC;AACA,QAAMI,cAAc,GAAG9D,aAAa,CAAC6D,aAAD,CAApC;AACA,QAAME,cAAc,GAAG;AACrBjD,IAAAA,EAAE,EAAEgD,cADiB;AAErB3D,IAAAA,OAAO,EAAE,IAFY;AAGrBS,IAAAA,MAAM,EAAE4C,SAHa;AAIrBG,IAAAA,WAAW,EAAE9C,IAAI,CAACC,EAJG;AAKrB8C,IAAAA,aAAa,EAAE/C,IALM;AAMrBqB,IAAAA,WAAW,EAAE,EANQ;AAOrB1B,IAAAA,eAAe,EAAE;AAPI,GAAvB;AASA,QAAMxB,IAAI,CAACQ,WAAD,EAAc,WAAd,EAA2BuE,cAA3B,CAAV;AAEA,QAAMhF,GAAG,CAAC;AACRmE,IAAAA,IAAI,EAAE/D,OAAO,CAAC6E,iBADN;AAERnD,IAAAA,IAAI,EAAE4C,OAFE;AAGRQ,IAAAA,QAAQ;AAAInD,MAAAA,EAAE,EAAE+C;AAAR,OAA0BH,WAA1B;AAHA,GAAD,CAAT;AAKD;;AACD,UAAUT,eAAV,GAA4B;AAC1B,QAAMiB,oBAAoB,GAAGC,IAAI,IAAI;AACnC,UAAM;AAAEjB,MAAAA,IAAF;AAAQkB,MAAAA;AAAR,QAAqBD,IAAI,CAACE,UAAL,GAAkB,CAAlB,CAA3B;AACA,UAAMC,aAAa,GAAGpB,IAAI,KAAK,UAA/B;;AACA,QAAI,CAACoB,aAAL,EAAoB;AAClB,aAAO;AAAEpB,QAAAA,IAAI,EAAE;AAAR,OAAP;AACD;;AACD,UAAMe,QAAQ,GAAGE,IAAI,CAACI,IAAL,CAAUH,QAAV,EAAoBD,IAApB,EAAjB;AAEA,WAAO;AACLjB,MAAAA,IAAI,EAAE/D,OAAO,CAACqF,yBADT;AAEL9C,MAAAA,OAAO,EAAE;AAAEuC,QAAAA;AAAF;AAFJ,KAAP;AAID,GAZD;;AAaA,QAAMjF,IAAI,CAACI,GAAG,CAACqF,SAAJ,CAAcC,cAAf,EAA+BrD,wBAA/B,EAAyD;AACjE6C,IAAAA;AADiE,GAAzD,CAAV;AAGD;;AACD,UAAUS,kBAAV,CAA6B;AAAEjD,EAAAA;AAAF,CAA7B,EAA0C;AACxC,QAAM;AAAEuC,IAAAA;AAAF,MAAevC,OAArB;AACA,MAAI;AAAEkD,IAAAA;AAAF,MAAelD,OAAnB;AAEA,QAAM5B,gBAAgB,GAAG,MAAMZ,MAAM,CAACS,mBAAD,CAArC;AAEA,MAAIoD,QAAJ;;AACA,MAAI6B,QAAQ,IAAIX,QAAQ,CAACnD,EAAT,KAAgBhB,gBAAgB,CAACgB,EAAjD,EAAqD;AACnDiC,IAAAA,QAAQ,GAAG,MAAM/D,IAAI,CAACO,mBAAD,EAAsB,UAAtB,EAAkC,CACrD,YADqD,EAErD,IAFqD,EAGrD0E,QAAQ,CAACnD,EAH4C,CAAlC,CAArB;AAKA8D,IAAAA,QAAQ,GAAG,IAAX;AACD;;AAED,QAAM7F,GAAG,CAAC;AACRmE,IAAAA,IAAI,EAAE/D,OAAO,CAAC0F,oBADN;AAERZ,IAAAA,QAFQ;AAGRlB,IAAAA,QAHQ;AAIR6B,IAAAA;AAJQ,GAAD,CAAT;AAMD;;AACD,eAAe,UAAUE,QAAV,GAAqB;AAClC,QAAMjG,GAAG,CAAC,CACRC,SAAS,CAACK,OAAO,CAAC4F,SAAT,EAAoBrC,QAApB,CADD,EAER5D,SAAS,CAACK,OAAO,CAACqF,yBAAT,EAAoCG,kBAApC,CAFD,EAGR7F,SAAS,CAACK,OAAO,CAAC6F,iBAAT,EAA4B5B,WAA5B,CAHD,EAIRtE,SAAS,CAACK,OAAO,CAAC8F,YAAT,EAAuB3B,UAAvB,CAJD,CAAD,CAAT;AAMD","sourcesContent":["import { all, takeEvery, put, call, fork, select } from 'redux-saga/effects';\r\nimport actions from './actions';\r\nimport { rsf, db } from '@iso/lib/firebase/firebase';\r\nimport {\r\n  getDocuments,\r\n  getDocumentsByQuery,\r\n  addDocument,\r\n  setDocument,\r\n  getNewDocRef,\r\n} from '@iso/lib/firebase/firebase.util';\r\nconst getSelectedChatRoom = state => state.Chat.selectedChatRoom;\r\nconst fsProps = {};\r\nconst reverseString = str =>\r\n  str\r\n    .split('')\r\n    .reverse()\r\n    .join('');\r\n\r\nconst sortChatrooms = (optionA, optionB) =>\r\n  optionB.lastMessageTime - optionA.lastMessageTime;\r\nconst sortMessages = (optionA, optionB) =>\r\n  optionA.messageTime - optionB.messageTime;\r\nconst getCurrentUser = () => {\r\n  return {\r\n    userId: 'wt4TiasxgPrQ3dNwVZ55',\r\n    user: {\r\n      id: 'wt4TiasxgPrQ3dNwVZ55',\r\n      dob: '06-Apr-1993',\r\n      gender: 'Male',\r\n      language: 'Burmese',\r\n      mobileNo: '5726784596',\r\n      name: 'Zondra Kulic',\r\n      profileImageUrl:\r\n        'https://s3.amazonaws.com/redqteam.com/mateadmin/support-male-zonra.png',\r\n    },\r\n  };\r\n};\r\n\r\nlet chatroomsUserCollections;\r\nlet chatroomCollectionRef = db.collection('chatRooms');\r\nlet messagesCollectionRef = db.collection('messages');\r\nconst sendMessageBatch = async ({ payload, selectedChatRoom }) => {\r\n  const batch = db.batch();\r\n  // const { chatRoom, text } = payload;\r\n\r\n  console.log(selectedChatRoom, payload, 'send');\r\n  const revId = reverseString(selectedChatRoom.id);\r\n  const messageTime = new Date().getTime();\r\n  const chatRoomModified = {\r\n    lastMessage: payload,\r\n    lastMessageTime: messageTime,\r\n  };\r\n  batch.update(\r\n    chatroomCollectionRef.doc(selectedChatRoom.id),\r\n    chatRoomModified\r\n  );\r\n  batch.update(chatroomCollectionRef.doc(revId), chatRoomModified);\r\n  batch.set(messagesCollectionRef.doc(), {\r\n    sender: selectedChatRoom.userId,\r\n    text: payload,\r\n    messageTime,\r\n    chatRoomId: selectedChatRoom.id,\r\n  });\r\n  batch.commit();\r\n  // yield fork(updateChatrooms);\r\n};\r\n\r\nfunction* initChat(action) {\r\n  // console.log(payload, 'chatinit');\r\n\r\n  const payload = getCurrentUser();\r\n  const users = yield call(getDocuments, 'users');\r\n\r\n  const chatRooms = yield call(getDocumentsByQuery, 'chatRooms', [\r\n    'userId',\r\n    '==',\r\n    payload.userId,\r\n  ]);\r\n  chatRooms.sort(sortChatrooms);\r\n  const messages = yield call(getDocumentsByQuery, 'messages', [\r\n    'chatRoomId',\r\n    '==',\r\n    chatRooms[0].id,\r\n  ]);\r\n  console.log(chatRooms, 'chatRooms');\r\n  messages.sort(sortMessages);\r\n  // fsProps.selectedChatRoom = chatRooms.length > 0 && chatRooms[0];\r\n  chatroomsUserCollections = db\r\n    .collection('chatRooms')\r\n    .where('userId', '==', payload.userId);\r\n  yield fork(updateChatrooms);\r\n  yield put({\r\n    type: actions.CHAT_INIT_SAGA,\r\n    user: payload.user,\r\n    userId: payload.userId,\r\n    users,\r\n    chatRooms,\r\n    messages,\r\n  });\r\n}\r\n\r\nfunction* sendMessage({ payload }) {\r\n  // fsProps.selectedChatRoom = payload.chatRoom;\r\n  const selectedChatRoom = yield select(getSelectedChatRoom);\r\n\r\n  yield call(sendMessageBatch, { payload, selectedChatRoom });\r\n  yield put({\r\n    type: actions.NEW_MESSAGE_SUCCESFULL,\r\n  });\r\n  // yield fork(updateChatrooms);\r\n}\r\nfunction* addNewUser({ user, addNewUsersProp }) {\r\n  const newUserId = yield call(addDocument, 'users', addNewUsersProp);\r\n  const newUser = { id: newUserId, ...addNewUsersProp };\r\n  const newChatroom = {\r\n    reverse: false,\r\n    userId: user.id,\r\n    otherUserId: newUserId,\r\n    otherUserInfo: newUser,\r\n    lastMessage: '',\r\n    lastMessageTime: 0,\r\n  };\r\n  const newChatRoomId = yield call(addDocument, 'chatRooms', newChatroom);\r\n  const chatRoomKeyRev = reverseString(newChatRoomId);\r\n  const newChatroomRev = {\r\n    id: chatRoomKeyRev,\r\n    reverse: true,\r\n    userId: newUserId,\r\n    otherUserId: user.id,\r\n    otherUserInfo: user,\r\n    lastMessage: '',\r\n    lastMessageTime: 0,\r\n  };\r\n  yield call(addDocument, 'chatRooms', newChatroomRev);\r\n\r\n  yield put({\r\n    type: actions.ADD_NEW_USER_SAGA,\r\n    user: newUser,\r\n    chatRoom: { id: newChatRoomId, ...newChatroom },\r\n  });\r\n}\r\nfunction* updateChatrooms() {\r\n  const successActionCreator = data => {\r\n    const { type, newIndex } = data.docChanges()[0];\r\n    const dataMoodified = type === 'modified';\r\n    if (!dataMoodified) {\r\n      return { type: 'NO_CHANGE' };\r\n    }\r\n    const chatRoom = data.docs[newIndex].data();\r\n\r\n    return {\r\n      type: actions.CHAT_UPDATE_CHATROOM_SAGA,\r\n      payload: { chatRoom },\r\n    };\r\n  };\r\n  yield call(rsf.firestore.syncCollection, chatroomsUserCollections, {\r\n    successActionCreator,\r\n  });\r\n}\r\nfunction* updateChatroomSaga({ payload }) {\r\n  const { chatRoom } = payload;\r\n  let { selected } = payload;\r\n\r\n  const selectedChatRoom = yield select(getSelectedChatRoom);\r\n\r\n  let messages;\r\n  if (selected || chatRoom.id === selectedChatRoom.id) {\r\n    messages = yield call(getDocumentsByQuery, 'messages', [\r\n      'chatRoomId',\r\n      '==',\r\n      chatRoom.id,\r\n    ]);\r\n    selected = true;\r\n  }\r\n\r\n  yield put({\r\n    type: actions.CHAT_UPDATE_CHATROOM,\r\n    chatRoom,\r\n    messages,\r\n    selected,\r\n  });\r\n}\r\nexport default function* rootSaga() {\r\n  yield all([\r\n    takeEvery(actions.CHAT_INIT, initChat),\r\n    takeEvery(actions.CHAT_UPDATE_CHATROOM_SAGA, updateChatroomSaga),\r\n    takeEvery(actions.CHAT_SEND_MESSAGE, sendMessage),\r\n    takeEvery(actions.ADD_NEW_USER, addNewUser),\r\n  ]);\r\n}\r\n"]},"metadata":{},"sourceType":"module"}